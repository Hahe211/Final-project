---
author: "hannah hess"
date: "December 4, 2018"
output: 
html_document:
 toc: true 
 highlight: tango   
 fig_caption: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stargazer)
library(gtrendsR)
library(tidyverse)
library(knitr)
library(readxl)

```

## <span style="color:red">Ramadan Causes a Decrease in Sex and Porn Related Searches in Five Muslim Majority Countries </span>

  Pornography and Ramadan may seem unrelated. However, these terms are very much linked both in real life and in Google searches. While pornography is always considered illicit in Islam, this is even more true over the month of Ramadan.  The message of Ramadan emphasizes pious behaviors and abtaining from physical pleasures: specifically sex, food and water during the daylight hours. Many musilms increase their observance over this time-period through fasting and attending mosque. 
  
  In light of this, Muslims who ordinarily flout the pornography prohibition might consider cleaning up their act for the Ramadan month.  All the while, many Muslim-majority countries are fighting a losing battle against rising consumption of pornography in their countries.  Many countries have attempted and failed to enact internet porn bans. 
  
###So, what is the impact of Ramadan on Pornography consumption in Muslim-majority countries? There is plausible reason to assume a negative or positive impact.    

On the one hand, Pornography might be thought to decrease over Ramadan as individuals increase in their religious observance and become busy with family holiday celebrations. On the other hand, given that Ramadan is often marked by shorter work or school day in Muslim countries, this might mean individuals have more free time to search for pornography. 

There has been previous research 

Based on previous research, high levels of Islamic observance in a country may be causally linked to pornography consumption. Research conducted on a state level in the US suggets that higher percentages of practicing Christians in a state predict higher frequencies of porn searching. (Andrew L. Whitehead & Samuel L. Perry (2018)) On the other had, another study showed that while religious areas purcahsed the same cumulative
in regions where more people report regularly attending religious services (per National Election Studies 2004), overall subscription rates are not statistically significantly different from subscriptions elsewhere However, in such regions, a statistically significantly smaller proportion of subscriptions begin on Sundays
  Edelman, B. (2009). 

  
  


![](Ramadans-Night-Prayers.jpg) 




###Why is this importnat?
  Examining differences in pornography consumption during Ramadan offers a fruitful metric for gauging soft measures of religious observance. While obviously, many Muslims will continue to consume pornography over the Holiday, flouting the prohibition, others will not. 
  
Ramadan consists of one month in the Islamic lunar calendar lasting about thirty-one days on average, which emphasizes rituals encouraging greater control over physical needs, specifically sex, food and water during the daylight hours. After sunset the fast concludes with prayers at the mosque and then family gathers for a festive breakfast meal, iftar which can last late into the night. 


###Testing the question with Data:

#####My data set:



####my results
 
This study shows a strong negative correlation between the presence of Ramadan and porn searching in majority Muslim countries. The presence of Ramadan in a Muslim country causes a decrease in the frequency of sex and porn related searches. Moreover, there is a ‘rebound effect’ of a 10% increase on Eid al-Futr the celebratory holiday following Ramadan.

```{r, echo = FALSE, message=FALSE, warning=FALSE, cache = TRUE}
#graphs pretty graphs

#read in data for the first graph which includes indicators for the presence of ramadan/eid and the value for sex and porn searches
#this was compiled in the document final_proj_code rmd  and includes the combined data from the 5 muslim majority countries over the past 5 years on a weekly basis 
#I tried grabbing from a longer time frame but unfortunately in that case the data could only be downloaded on a month level. The right approach for the future would probably be to download twice in 5 year incremements and then bind_cols


data <- read_rds("data.rds") %>% 
select(-keyword, -date1, -date2, -date3, -date4, -date5, -date6) %>% 
#I realized late that the data pulled on 2013 does not include ramadan, since the google code for the last 5 years counts backward from today*12/11/18. As a result, I'm filtering up for only 2014 and above.
#in the future, I would add more years but for now this will suffice
  filter(year > 2013)


graph1 <- data %>%
  mutate(hits = hits.porn,
         category = "porn") %>%
  select(hits, category, date, in_ram)

graph2 <- data %>%
  mutate(hits = hits.sex,
         category = "sex") %>%
select(hits, category, date, in_ram)

#combine the data for sex and porn searchs in a way which will allow you to create a line graph with two categories
graph3 <- bind_rows(graph1, graph2)

#read in data of ramadan dates
ramadan_dates <- read_excel("ramadan_dates.xlsx") %>% 
filter(year >= 2014, Holiday == "Ramadan")





#full graph of all the countries in the study (the graph is very compact so I also make another one with only 2 countries so you can see the relationship more easily) #the code below is a graph with grey areas indicating ramadan.
#it also might like better with color filled underneath - for future experiment

ggplot() + geom_line(data = data, aes(x = date, y = sum))+ geom_rect(data= ramadan_dates, aes(xmin=start, xmax=end, ymin=-Inf, ymax=+Inf), alpha = 0.3) + labs(title="'Porn' and 'Sex' Search Values over the Past 5 Years", subtitle = "Values Decrease over Ramadan - Shaded Grey", x ="Weeks from 2013-2018", y = "Hit Values", caption = "Data Drawn from SA, JO, EG, MA, UAE")



#second graph of weekly data of the past five years - fewer countries so clearer lines
yearly <- gtrends(c("sex","porn"), geo = c("SA", "JO"), time = "today+5-y")  
yearly = yearly$interest_over_time

ggplot() + geom_line(data = yearly, aes(x = date, y = hits, colour = keyword)) + geom_rect(data = ramadan_dates, aes(xmin=start, xmax=end, ymin=-Inf, ymax=+Inf), alpha = 0.2) +labs(title="'Porn' and 'Sex' Search Values over the Past 5 Years", subtitle = "Sex and porn related searches decrease Over Ramadan",  x ="Weeks from 2013-2018", y = "Hit Values", caption = "Data Drawn from Only Saudi Arabia and Jordan for Easy Viewing")


```



 


###Data and Multiple Linear Regression 

There are 1305 observations, 1 per week from 2013 to 2018. Data is collected from 5 Muslim majority countries across three continents, namely, Jordan, Saudi Arabia, Egypt, United Arab Emirates and Malaysia.

*Numbers represent search interest relative to the highest point on the chart for the given region and time. A value of 100 is the peak popularity for the term. A value of 50 means that the term is half as popular. A score of 0 means there was not enough data for this term. *

----------------


```{r, echo = FALSE, message = FALSE, warning= FALSE, results = "asis", cache = TRUE}


#creating display table of summary stats
#using the data frame "graph" which represents the D1_interest data frame from 'final_proj_code1'
#results set to "asis" in order to use html in stargazer

 data %>% 
  select(-days_in_ram, -days_in_eid, -in_ram, -in_eid, -category, -before_ram) %>%
  stargazer(type = "html", title="Summary statistics", digits=1, flip = TRUE, summary.logical= FALSE)
```

-------------------


Controlling for country and year, Ramadan causes a sigificant decrease in sex and porn related searches in five muslim majority countries of around 10 percentages points. As seen in (4) people decrease these searches in the week leading up to Ramadan by about two percentage points. However, in the week following, also known as Eid al-Futr, people significantly increase their searches by around 20 percentage points (seen in 3 and 4). My results are significant p < .01.


-----------------------


*"Days in Ramadan" is a continuous variable with values zero through seven, designating the number of days in a a given week which include Ramadan. "Presence of Ramadan" is a binary variable with values of one or zero based on the presence of absence of Ramadan.*

*"In Eid" is a categorical variable which registers the presence of Eid al-Futr in a given week. Eid al-Futr is a three day feasting holiday which always occurs immediately following Ramadan. Thus, "In Eid" is standing in place for an "after ramadan" variable* 



```{r, echo = FALSE, message = FALSE, warning= FALSE, results = "asis"}
#regression analysis - putting togethor the regressions
#year and country controls dont make a difference in p values, sd, or coeff so I'm back to removing them -  because data set is already normalized for year and country
ma <- lm(sum ~ days_in_ram, data=data)
mb <- lm(sum ~ in_ram, data=data)
m1 <- lm(sum ~ in_ram + in_eid, data=data)
m3 <- lm(sum ~ before_ram + in_ram + in_eid, data = data)
#this is the regression of2 weeks before ramadan, I'm commenting out for this first study, but it is noteworthy since it changes the results
#m4 <- lm(sum ~ before2_ram + before_ram + in_ram + in_eid, data = graph)


#use results = asis in the caption to make sure the table prints properly
#final regression code
 stargazer(ma, mb, m1, m3, summary = FALSE, type = "html", title = "Changes in Sex and Porn Related Search Values Over Ramadan", dep.var.labels = "Mean values for 'sex' and 'porn' hits by Week",covariate.labels = c("Days in Ram", "Week Before Ram (0 or 1)", "Presence of Ram (0 or 1)", "Presence of Eid (0 or 1)"))



```


----------------

### <span style="color:red">A Global Impact? </span>


Given that Muslims make up about %24 percent of the global population, does the presence of Ramadan may have an impact on worldwide pornography searching?

Exploiting search values aggregated on a global level  - the cumulative global value of sex and porn searches decresaes over Ramadan by one and a half percentage points at the .1 significance level. 

The Muslim population has been projected to increase by about 1.5% a year and by 2060 Muslims will constitute about %32 percent of the global population so their influence on Google trends might increase over time.


-----------------------------

```{r, echo = FALSE, message = FALSE, warning= FALSE, results = "asis", cache = TRUE}
#read in world data
world <- read_rds("world.rds")

w1 <- lm(sum ~ in_ram, data=world)


 stargazer(w1, summary = FALSE, type = "html", title = "Global Level Changes in Sex and Porn Related Search Values Over Ramadan", dep.var.labels = "Mean values for 'sex' and 'porn' hits by Week",covariate.labels = "Presence of Ram (0 or 1)")



```

---------------------

### <span style="color:red">Why the Dip? </span>


Dips in porn consumption over Ramadan may correspond to levels of individual religious observance. However, there could also be social factors of stigma associated with non-observance of Ramadan, which would alter individual practice.


Given that most pornography searches occur at night schedule changes during Ramadan and late family gatherings likely render a significant impact to searching activities.  Additionally, bio-chemical or neurological changes associated with fasting have been [shown](http://www.urologyjournal.org/index.php/uj/article/viewFile/2787/1027) to decrease levels of libido and alter interest in pornographic content. Moreover, many countries have Ramadan laws, which [criminalize](http://www.bbc.co.uk/religion/religions/islam/practices/ramadan_1.shtml) public acts of non-observance.
  

```{r, cache = TRUE, echo = FALSE, message=FALSE, warning=FALSE}

#Optional hourly code for saudi, commented out
# hourly <- gtrends(c("sex","porn"), gprop = "web", geo = c("SA"), time = "now 7-d") 
# 
#  hourly$interest_over_time %>% 
#   mutate(day = lubridate::wday(date, label = TRUE), hour = lubridate::hour(date)) %>% 
#     ggplot() +
#   geom_line(aes(x = hour, y = hits, colour = keyword)) +
#   geom_smooth(aes(x = hour, y = hits), se = FALSE) +
#   facet_grid(. ~ day) +
#   theme_bw() + 
#   theme(legend.position = 'top') +
#   scale_x_continuous(breaks = c(6, 12, 18, 24)) +
#   labs(y = NULL, x = "Time of Day", 
#        caption = "November 27, 2018 11:00am to December 4, 2018 1:00pm",
#        colour = NULL, title = "Google Trends Popularity of 'porn' or 'sex' over a Week in Saudi Arabia")
# 

#I redownload the data on an hourly level, hourly data is only availablefrom grends if you download in the last week
#be careful that if I grab the data again then I will have to change the caption because the date will change!
 hourly2 <- gtrends(c("sex","porn"), gprop = "web", geo = c("JO"), time = "now 7-d") 

hourly2$interest_over_time %>% 
  mutate(day = lubridate::wday(date, label = TRUE), hour = lubridate::hour(date)) %>% 
    ggplot() +
  geom_line(aes(x = hour, y = hits, colour = keyword)) +
  geom_smooth(aes(x = hour, y = hits), se = FALSE) +
  facet_grid(. ~ day) +
  theme_bw() + 
  theme(legend.position = 'top') +
  scale_x_continuous(breaks = c(6, 12, 18, 24)) +
  labs(y = NULL, x = "Time of Day", 
       caption = "November 27, 2018 11:00am to December 4, 2018 1:00pm",
       colour = NULL, title = "Google Trends Popularity of 'porn' or 'sex' over a Week in Jordan", subtitle = "Most Hits Occur in the Evening Hours")

```
  



```{r, include = FALSE, warning= FALSE}

#code to prep for graphs
#code a categorical variable for ramadan/not ramadan/eid after Ramadan
data$scode <- NA
data$scode[data$in_ram==0] <- "Not Ramadan"
data$scode[data$in_ram==1] <- "Ramadan"
data$scode[data$in_eid== 1] <- "Eid_after_Ramadan"


#arrange by country with highest porn viewing
geo_sum <-   data %>%
  group_by(geo)%>%
  summarise(sum = median(sum, na.rm = TRUE))%>%
        arrange(sum) %>% 
          mutate(geo = factor(geo, levels = .$geo))




#then organize by ramadan vs not ramadan 
#I divide 
geo_lev_ram <-  data %>%
        group_by(geo, scode) %>%
  #find the median weekly value in Ramadan/not ramadan by Geo, I choose median bc more robust to outliers
        summarise(sum = median(sum, na.rm = TRUE)) %>%
        ungroup() %>% 
        mutate(geo = factor(geo, levels = geo_sum$geo)) 
     

#lolly plot, weekly median porn viewing Ramadan vs not ramadan 
ggplot(geo_lev_ram, aes(sum, geo)) +   #include label = year if wish to add label to aes with year marks, would also need to adjust geo_sum above
        geom_line(aes(group = geo)) +
        geom_point(aes(color = scode))
       



```

Which Countries exhibit the most significant decrease? 

```{r, message=FALSE, echo=FALSE, warning = FALSE}

#try another graph where I lable the percent increase
#create frame with the values of the percent change
big_diff <- geo_lev_ram %>% 
        spread(scode, sum) %>% 
        group_by(geo) %>% 
     #calculate list of percent change btwn ram and not ram
        mutate(Diff = (Ramadan - `Not Ramadan`)/`Not Ramadan`)

   

#create labal frame
after_ram_label <- geo_lev_ram %>%
        group_by(geo) %>%
        arrange(desc(sum)) %>%
        top_n(1)

not_ram_label <- geo_lev_ram %>%
        group_by(geo) %>%
        arrange(desc(sum)) %>%
        slice(2)

ram_label <-  geo_lev_ram %>%
        group_by(geo) %>%
        arrange(desc(sum)) %>%
        slice(3)

# filter the label data frames to only include those countries where the
# difference exceeds 20%
# right_label <- filter(right_label, geo %in% big_diff$geo)
# left_label <- filter(left_label, geo %in% big_diff$geo)

highlight <- filter(geo_lev_ram, geo %in% big_diff$geo)

#create ggplot which has values labels for the 3 s-code points
#I am muting this code because I would rather have the second graph showing percent changes
 # ggplot(geo_lev_ram, aes(sum, geo)) +
 #        geom_line(aes(group = geo), alpha = .3) +
 #        geom_point(aes(color = scode), size = 1.5, alpha = .3) +
 #        geom_line(data = highlight, aes(group = geo)) +
 #        geom_point(data = highlight, aes(color = scode), size = 2) +
 #        geom_text(data = after_ram_label, aes(color = scode, label = round(sum, 0)),
 #                  size = 3, hjust = -.5, check_overlap = TRUE, size = 4, angle = 45) +
 #        geom_text(data = not_ram_label, aes(color = scode, label = round(sum, 0)),
 #                  size = 3, hjust = 1.5, check_overlap = TRUE, size = 4, angle = 45) +
 #        geom_text(data = ram_label, aes(color = scode, label = round(sum, 0)),
 #                  size = 3, hjust = 1.5, check_overlap = TRUE, size = 4, angle = 45) +
 #        scale_x_continuous()

     



# create a new label data frame for percent changes
plot_label <- big_diff %>%
        select(geo, sum = Ramadan, Diff) 
#create a graph with percent change labels instead of point labels
 p<- ggplot(geo_lev_ram, aes(sum, geo)) +
        geom_line(aes(group = geo), alpha = .3) +
        geom_point(aes(color = scode), size = 1.5, alpha = .3) +
        geom_line(data = highlight, aes(group = geo)) +
        geom_point(data = highlight, aes(color = scode), size = 2) +
        geom_text(data = plot_label, aes(label = paste0(scales::percent(round(Diff, 2)))),
                  size = 3, hjust = .05, vjust = -.8) 
   




#add titles to plot and also a nice theme

p + scale_color_discrete(labels = c("After Ramadan", "Ramadan", "Rest of Year")) +
        #scale_y_discrete(expand = c(.02, 0)) +
        labs(title = "Changes in Median Weekly Porn Search Values over Ramadan",
             subtitle = "8 Out of the 11 Muslim Countries studied have a decrease in porn consumption of over 20% in Ramadan weeks")+
         xlab("Median Weekly Porn Consumption")+
        theme_minimal() +
        theme(axis.title = element_blank(),
              panel.grid.major.x = element_blank(),
              panel.grid.minor = element_blank(),
              legend.title = element_blank(),
              legend.justification = c(0, 1), 
              legend.position = c(.1, 1.075),
              legend.background = element_blank(),
              legend.direction="horizontal",
              text = element_text(family = "Georgia"),
              #plot.title = element_text(size = 20, margin = margin(b = 10)),
              plot.subtitle = element_text(size = 9, color = "darkslategrey", margin = margin(b = 25)),
              plot.caption = element_text(size = 8, margin = margin(t = 10), color = "grey70", hjust = .5))+
              scale_y_discrete(labels = c("Iran", "Libya", "Turkey", "Saudi Arabia", "Tunisia,", "Jordan", "Egypt", "Afghanistan", "Malaysia", "UAE", "Pakistan"))

#This was a great resource I was designing my plot! http://uc-r.github.io/cleveland-dot-plots 
```


###*By: Hannah Hess, Harvard College 2019*


