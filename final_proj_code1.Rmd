---
title: "regression analysis"
author: "hannah hess"
date: "November 29, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(stargazer)
library(gtrendsR)
library(tidyverse)
library(knitr)
library(readxl)
```

This is a page for regression analysis, tables and charts
in another page, I will look at graphs of - popular hours for porn consumption, changes in porn consumption over time

 
first - try to pull a cross country data frame from google then combine by country... although I could make life easy on myself and not pull more than two countries. 
```{r}

#create preliminary data set from gtrends - last 5 years



  #donload data
D1 <- gtrends(keyword = "sex", geo = c("EG", "SA", "AE", "PK", "MA"), time = "today+5-y")
D1_interest <- D1$interest_over_time 

#download world data to see if theres a world influence
world <- gtrends(keyword = "sex", time = "today+5-y")
world_interest <- world$interest_over_time 


#load the data set I made with dates of ramadan and major holidays

ramadan_dates <- read_excel("ramadan_dates.xlsx")


```


```{r}
#dowload data set for more countries 



```


```{r}
#showing/determining high volume porn searches 


#justify that I'm picking the right terms (warning explicit content) - since I'm focused with change over time - its not critical that I isolate all the relevant terms but just that they indeed be pornography serach terms  adn that they capture a high level of the variation over time
  
D1$related_queries %>% 
     select(subject, value) %>% 
      slice(1:10)




```


```{r}


#I have a problem: the gtrends data set does not indicate the presence or absence of Ramadan. I have to pull that info from a different data set I have called ramadan_holiday
#My google trends data set (D1_interest) includes ramadan search values for a whole week 
#manipulate data set to add all days of the week 
D1_interest$date1 = as.Date(D1_interest$date) + 1 
D1_interest$date2 = as.Date(D1_interest$date) + 2 
D1_interest$date3 = as.Date(D1_interest$date) + 3 
D1_interest$date4 = as.Date(D1_interest$date) + 4 
D1_interest$date5 = as.Date(D1_interest$date) + 5 
D1_interest$date6 = as.Date(D1_interest$date) + 6 

D1_interest$year <- substring(D1_interest$date,1,4)


#For loop to create (1) a "days_in_ram" variable ->  the number of days in a given week with ramadan present and also (2) "in_ram" variable -> (0 or 1) whether or not ramadan is present in that week
#first iterate over a week in a given year in the D1_interests data set to see if there are any matches for Ramadan occuring
#count the number of days of a given week in teh D1_interest$date variable which overlap with ramadan
#create a binary variable to code 1 if a week includes more than 3 days of ramadan. 

for (i in 1:length(D1_interest$date)) {
  D1_interest[i, "days_in_ram"] = 0 
  for( j in c("date" , "date1", "date2" , "date3", "date4", "date5", "date6")){
    if ( (D1_interest[i, j] > ramadan_dates[ramadan_dates$year==   D1_interest[i, "year"]   &  ramadan_dates$Holiday == "Ramadan" , ]$start  ) & (D1_interest[i, j] < ramadan_dates[ramadan_dates$year== D1_interest[i,"year"] & ramadan_dates$Holiday == "Ramadan" ,]$end  ) ) {
        D1_interest[i, "days_in_ram"] =   D1_interest[i, "days_in_ram"]  + 1
    }
  }
  
  if (D1_interest[i, "days_in_ram"] > 2){
      D1_interest[i,"in_ram"] = 1
  } else{
      D1_interest[i,"in_ram"] = 0
  }
  
  
}

#Thank you to Eric Wasserman Harvard 2019 Dunster House for helping me conceptualize how best to approach the coding problem above!


#my next step in data manipulation before running a regression will be to add an additional variable for year so that I can control #for that. 
#I also may go back up (before doing the ramadan stuff) and create a combined variable of porn searches called porn which is the #average of the high volume porn searches I've found 






```



```{r}
#repeat the ramadan iteration but this time for celebratory holidays

#first I'll manipulate the ramadan_dates to code "celebratory holiday for Eid



#For loop to create (1) a "days_in_ram" variable ->  the number of days in a given week with ramadan present and also (2) "in_ram" variable -> (0 or 1) whether or not ramadan is present in that week
#first iterate over a week in a given year in the D1_interests data set to see if there are any matches for Ramadan occuring
#count the number of days of a given week in teh D1_interest$date variable which overlap with ramadan
#create a binary variable to code 1 if a week includes more than 3 days of ramadan. 

#ERROR MESSAGE HAVING DIFFICULTY!!

for (i in 1:length(D1_interest$date)) {
  D1_interest[i, "days_in_eid"] = 0 
  for( j in c("date" , "date1", "date2" , "date3", "date4", "date5", "date6")){
    if ( (D1_interest[i, j] > ramadan_dates[ramadan_dates$year==   D1_interest[i, "year"]   &  ramadan_dates$Holiday ==  "Eid al-Fitr" , ]$start  ) & (D1_interest[i, j] < ramadan_dates[ramadan_dates$year== D1_interest[i,"year"] & ramadan_dates$Holiday ==  "Eid al-Fitr"  ,]$end  ) ) {
        D1_interest[i, "days_in_eid"] =   D1_interest[i, "days_in_eid"]  + 1
    }
  }
  
  
}

#Thank you to Eric Wasserman Harvard 2019 Dunster House for helping me conceptualize how best to approach the coding problem above!


#my next step in data manipulation before running a regression will be to add an additional variable for year so that I can control #for that. 
#I also may go back up (before doing the ramadan stuff) and create a combined variable of porn searches called porn which is the #average of the high volume porn searches I've found 


```


```{r}

#repeat the above step but for WORLD data to test if there's a global impact



#I have a problem: the gtrends data set does not indicate the presence or absence of Ramadan. I have to pull that info from a different data set I have called ramadan_holiday
#My google trends data set (D1_interest) includes ramadan search values for a whole week 
#manipulate data set to add all days of the week 
world_interest$date1 = as.Date(world_interest$date) + 1 
world_interest$date2 = as.Date(world_interest$date) + 2 
world_interest$date3 = as.Date(world_interest$date) + 3 
world_interest$date4 = as.Date(world_interest$date) + 4 
world_interest$date5 = as.Date(world_interest$date) + 5 
world_interest$date6 = as.Date(world_interest$date) + 6 

world_interest$year <- substring(world_interest$date,1,4)


#For loop to create (1) a "days_in_ram" variable ->  the number of days in a given week with ramadan present and also (2) "in_ram" variable -> (0 or 1) whether or not ramadan is present in that week
#first iterate over a week in a given year in the D1_interests data set to see if there are any matches for Ramadan occuring
#count the number of days of a given week in teh D1_interest$date variable which overlap with ramadan
#create a binary variable to code 1 if a week includes more than 3 days of ramadan. 

for (i in 1:length(world_interest$date)) {
  world_interest[i, "days_in_ram"] = 0 
  for( j in c("date" , "date1", "date2" , "date3", "date4", "date5", "date6")){
    if ( (world_interest[i, j] > ramadan_dates[ramadan_dates$year==   world_interest[i, "year"]   &  ramadan_dates$Holiday == "Ramadan" , ]$start  ) & (world_interest[i, j] < ramadan_dates[ramadan_dates$year== world_interest[i,"year"] & ramadan_dates$Holiday == "Ramadan" ,]$end  ) ) {
        world_interest[i, "days_in_ram"] =   world_interest[i, "days_in_ram"]  + 1
    }
  }
  
  if (world_interest[i, "days_in_ram"] > 2){
      world_interest[i,"in_ram"] = 1
  } else{
      world_interest[i,"in_ram"] = 0
  }
  
  
}





```


```{r}
#surveying my handiwork:)
#country level data
D1_interest <- D1_interest %>% 
  select(date, geo, days_in_ram, in_ram, hits, year) 


      
head(D1_interest)

#global data
world_interest <- world_interest %>% 
    select(date, days_in_ram, in_ram, hits, year)

head(world_interest)
  
```




```{r}
#regression analysis

#descriptive statistics

des_table <- stargazer(D1_interest, type = "text", title="Descriptive statistics", digits=1)


#CODE FOR SELECTIVE DESCRIPTIVE Stats
# stargazer(mydata[c("mpg","hp","drat")], type = "text",
#  title="Descriptive statistics/selected variables", digits=1, out="table2.txt", flip=TRUE,
#  covariate.labels=c("Miles/(US)gallon","Gross horsepower","Rear axle ratio"))


#Make a regression table
#first regression without year or country controls
ma <- lm(hits ~ days_in_ram, data=D1_interest)

#adding country controls
mb <- lm(hits ~ days_in_ram + geo, data=D1_interest)
#both year and country controls, switching between in_ram and days_in_ram
m1 <- lm(hits ~ in_ram + geo + year, data=D1_interest)
m2 <- lm(hits ~ days_in_ram + geo + year, data=D1_interest)

#year and country controls dont make a difference in p values, sd, or coeff so I'm back to removing them - probably because data set is already normalized for year and country
m1 <- lm(hits ~ in_ram , data=D1_interest)
m2 <- lm(hits ~ days_in_ram, data=D1_interest)



#sig impact detected! .2 percentage point degrease
reg_table <- 
  stargazer(ma, mb, m1, m2, type="text", dep.var.labels= "Country level porn hits")

 covariate.labels=c("Gross horsepower","Rear axle ratio","Four foward gears",
 "Five forward gears","Type of transmission (manual=1)"))

kable(reg_table)



#global data -  sig impact detected
m3 <- lm(hits ~ days_in_ram, data=world_interest)
m4 <-  lm(hits ~ in_ram, data=world_interest)

#make a seperate table for world data


#options moving forward - I could either include celebratory holidays OR look at it on a regional level - ie: middle eastern vs south asian countries vs gulf countries. 

```



#create and merge large data set organized by year and dates and countries which show the occurence of ramadan 






Variable names:
country 
year 
Ramadan vs not ramadan 
search volume (porn/sex)






It's important to acknowledge that the population covered in my study are those people who access pornography searches not through a proxy site and it is likely that this population would differ somewhat from those who use a proxy site and are not found on google. thus my sample size is not representative of the population as a whole 
